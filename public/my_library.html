<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì„œì¬ - ë‚´ ì†ì•ˆì˜ ë„ì„œê´€</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="topbar">
        <a href="/">
            <div class="logo">
                OPEN-Library
            </div>
        </a>
        <div class="topright" id="userNav">
            <!-- ì—¬ê¸°ì— ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ì´ ë“¤ì–´ê° -->
        </div>
    </div>

    <main class="app">
        <div class="results-container">
            <h2 style="margin-bottom: 20px;">ğŸ“– ë‚´ ì„œì¬</h2>
            <p style="margin-bottom: 30px; color: var(--text-secondary);">ë‚´ê°€ ì˜ˆì•½í•œ ë„ì„œ ëª©ë¡ì…ë‹ˆë‹¤.</p>
            <div id="reservationList" class="book-grid">
                <!-- ì˜ˆì•½í•œ ì±…ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
            </div>
        </div>
    </main>

    <script src="js/script.js"></script>
    <script>
        // ë‚´ ì„œì¬ í˜ì´ì§€ ì „ìš© ë¡œì§
        document.addEventListener('DOMContentLoaded', async () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.');
                window.location.href = '/login.html';
                return;
            }

            const listContainer = document.getElementById('reservationList');

            try {
                const response = await fetch(`/api/user/${currentUser.id}/reservations`);
                const result = await response.json();

                if (result.success && result.reservations.length > 0) {
                    listContainer.innerHTML = result.reservations.map(res => {
                        console.log('Reservation:', res); // ë””ë²„ê¹…ìš© ë¡œê·¸
                        // ë‚ ì§œ í¬ë§·íŒ…
                        const dueDate = res.due_date ? res.due_date : 'ì •ë³´ ì—†ìŒ';
                        // extension_countê°€ 0ì´ê±°ë‚˜ NULLì´ë©´ ì—°ì¥ ê°€ëŠ¥
                        const canExtend = (res.extension_count === 0 || res.extension_count === null);

                        return `
                        <div class="book-card">
                            <img src="${res.imgUrl}" alt="${res.title}" class="book-cover">
                            <div class="book-info">
                                <div class="book-title">${res.title}</div>
                                <div class="book-author">${res.author}</div>
                                <p class="reservation-date">ì˜ˆì•½ì¼: ${res.date}</p>
                                <p class="reservation-date" style="color: #D32F2F; font-weight: bold;">ë°˜ë‚© ì˜ˆì •ì¼: ${dueDate}</p>
                                
                                <div class="button-group" style="display: flex; gap: 8px; margin-top: 8px;">
                                    <button class="btn-primary" style="padding: 6px 12px; font-size: 0.9rem;"
                                        onclick="extendBook(${res.reservation_id}, ${currentUser.id})"
                                        ${!canExtend ? 'disabled style="background-color: #ccc; cursor: not-allowed;"' : ''}>
                                        ${canExtend ? 'ì—°ì¥í•˜ê¸°' : 'ì—°ì¥ì™„ë£Œ'}
                                    </button>
                                    <button class="btn-text" style="padding: 6px 12px; font-size: 0.9rem; color: #D32F2F; border: 1px solid #D32F2F;"
                                        onclick="cancelBook(${res.reservation_id}, ${currentUser.id})">
                                        ì˜ˆì•½ì·¨ì†Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                } else {
                    listContainer.innerHTML = '<p>ì•„ì§ ì˜ˆì•½í•œ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (error) {
                console.error(error);
                listContainer.innerHTML = '<p>ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        });

        async function extendBook(reservationId, userId) {
            if (!confirm('ë°˜ë‚© ê¸°í•œì„ 7ì¼ ì—°ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (1íšŒë§Œ ê°€ëŠ¥)')) return;

            try {
                const response = await fetch('/api/extend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reservationId, userId })
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error(error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function cancelBook(reservationId, userId) {
            if (!confirm('ì •ë§ë¡œ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch('/api/cancel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reservationId, userId })
                });
                const result = await response.json();
                alert(result.message);
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error(error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>

</html>